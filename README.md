# RC

Минимальный прототип коммуникационной платформы (комнаты, текстовые/голосовые каналы, медиа, сигналинг WebRTC).

## Структура проекта

- `server/` — Node.js API + WebSocket сигналинг.
- `client/` — статический браузерный клиент.
- `deploy/` — инструкции для деплоя на Windows Server 2025.

## Быстрый запуск локально

### Сервер

```bash
cd server
npm install
npm start
```

### Клиент

```bash
cd client
python -m http.server 5173
```

Откройте `http://localhost:5173?api=http://localhost:3001`.

## Проверка взаимодействия

1. Зарегистрируйте пользователя.
2. Создайте комнату и канал.
3. Отправьте сообщения/эмодзи/картинки.
4. Подключитесь к голосовому каналу и включите демонстрацию экрана.

**********************************************************************************************************

## Быстрый запуск локально

### Сервер

```bash
cd server
npm install
npm start
```

### Клиент

```bash
cd client
python -m http.server 5173
```

Откройте `http://localhost:5173?api=http://localhost:3001`.

## Проверка взаимодействия

1. Зарегистрируйте пользователя.
2. Создайте комнату и канал.
3. Отправьте сообщения/эмодзи/картинки.
4. Подключитесь к голосовому каналу и включите демонстрацию экрана.

## Установка и запуск на Windows Server (рекомендуется для прод)

### Необходимые компоненты

1. **Node.js LTS** (для `server/`). Проверьте установку: `node -v`, `npm -v`.
2. **Процесс-менеджер**:
   - Вариант 1: `pm2` (прост в настройке). Установка: `npm install -g pm2`.
   - Вариант 2: `nssm` (Windows service wrapper).
3. **TLS/HTTPS сертификаты**:
   - Для домена — автоматически через Let’s Encrypt (например, `win-acme`).
   - Для IP-адреса — самоподписанный сертификат (браузеры будут показывать предупреждение).
4. **Статический хостинг/реверс-прокси** (например, Caddy или Nginx), чтобы раздавать `client/` и проксировать API/WS на Node.js.

### Сборка и запуск

#### Сервер

```bash
cd server
npm install
set PORT=3001
npm start
```

Для фонового запуска через `pm2`:

```bash
cd server
pm2 start index.js --name rc-server
pm2 save
```

#### Клиент

Клиент статический, сборка не требуется. Его можно:

- раздавать через `python -m http.server 5173` (для тестов),
- или отдать через реверс-прокси (рекомендуется).

### Переменные окружения

- `PORT` — порт API сервера (по умолчанию `3001`). Используется в `server/index.js`.

### Открытие портов в Windows Firewall

Минимальный набор:

- `80/tcp` и `443/tcp` — доступ к клиенту и HTTPS.
- `3001/tcp` — API/WS, если нет реверс-прокси.
- `5173/tcp` — dev/тестовый статический сервер (опционально).

Для WebRTC нужен доступ в интернет и UDP-трафик; при использовании TURN-сервера открывайте его порт (обычно `3478/udp`).

### Пример домена/IP, HTTPS и проверки работоспособности

#### Пример для IP `89.110.93.27` и домена `rc.example.com` (Caddy)

`Caddyfile`:

```
rc.example.com {
  encode gzip
  root * C:\RC\client
  file_server
  reverse_proxy /api/* 127.0.0.1:3001
  reverse_proxy /ws* 127.0.0.1:3001
}
```

Для IP без домена (самоподписанный сертификат):

```
https://89.110.93.27 {
  tls internal
  root * C:\RC\client
  file_server
  reverse_proxy /api/* 127.0.0.1:3001
  reverse_proxy /ws* 127.0.0.1:3001
}
```

Проверки:

```bash
curl -I https://rc.example.com
curl -i https://rc.example.com/api/rooms
```

Ожидается `200` на корне и `401 Unauthorized` на `/api/rooms` (без токена).

### Траблшутинг

- **Порт занят**: измените `PORT` или освободите порт; проверьте `netstat -ano | findstr :3001`.
- **Клиент не видит API**: убедитесь, что URL содержит `?api=https://rc.example.com` или что реверс-прокси проксирует `/api` и `/ws`.
- **WebRTC не подключается**: проверьте, что сервер доступен по HTTPS (браузеры блокируют `getUserMedia` без HTTPS, кроме `localhost`) и открыт UDP-трафик.
- **Нет микрофона/экрана**: разрешите доступ в браузере, проверьте системные политики Windows и выберите правильное устройство ввода.
